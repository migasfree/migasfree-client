#!/bin/bash

# Copyright (c) 2011-2025 Jose Antonio Chavarr√≠a <jachavar@gmail.com>
#
# Script to create distribution packages (.deb, .rpm)

set -e

function create_package
{
    if [ -f stdeb.cfg ]
    then
        echo "Creating Debian package..."
        python3 setup.py --command-packages=stdeb.command bdist_deb
    else
        echo "Creating RPM package..."
        python3 setup.py bdist_rpm
    fi
}

function get_distro
{
    local _DISTRO

    _DISTRO=$(python3 -c "from migasfree_client import utils; print(utils.get_distro_name())")

    if [ -f "setup.cfg.d/$_DISTRO" ]
    then
        ln -sf "setup.cfg.d/$_DISTRO" setup.cfg
        echo "$_DISTRO"
        return
    fi

    if [ -f "stdeb.cfg.d/$_DISTRO" ]
    then
        ln -sf "stdeb.cfg.d/$_DISTRO" stdeb.cfg
        echo "$_DISTRO"
        return
    fi

    echo ""
}

##############
# main process
##############

cd ..

DISTRO=$(get_distro)
if [ -z "$DISTRO" ]
then
    echo "Computer distro is not available. Aborting package creation."
    exit 1
fi

echo "Detected distro: $DISTRO"
create_package
echo "Package creation completed."
